<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dobbelspelletje</title>
    <link rel="stylesheet" href="css/styles.css" />
  </head>

  <body>
    <h1>dobbelspelletje</h1>
    <div id="menu">
      <label for="txtGameId">Spelnaam: </label>
      <input type="text" id="txtGameId" />
      <button id="btnCreate">Maak spel</button>

      <div id="gamesList"></div>
      <button id="closeGames">Close Games</button>
    </div>
    <div id="gameWindow">
      <div id="player1board">
        player1
        <div id="player1"></div>
      </div>
      <div id="gameScreen">
        <button id="btnDice">Throw dice</button>
        <button id="endTurn">End turn</button>

        <div id="divPlayers"></div>
        <div id="tegels"></div>
        <hr />
        <div id="divBoard"></div>
        <div id="totaal"></div>
        <div id="selectedDice"></div>
      </div>
      <div id="player2board">
        player2
        <div id="player2"></div>
      </div>
    </div>
    <script>
      //HTML elements
      let clientId = null;
      let gameId = null;
      let playerColor = null;
      let overgebleven = null;
      let total = null;

      let HOST = location.origin.replace(/^http/, "ws");
      let ws = new WebSocket(HOST);
      const btnCreate = document.getElementById("btnCreate");
      const menuDiv = document.getElementById("menu");
      const txtGameId = document.getElementById("txtGameId");
      const divTegels = document.getElementById("tegels");
      const divPlayers = document.getElementById("divPlayers");
      const divBoard = document.getElementById("divBoard");
      const player1 = document.getElementById("player1");
      const gamesList = document.getElementById("gamesList");
      const btnDice = document.getElementById("btnDice");
      const endTurn = document.getElementById("endTurn");
      const closeGames = document.getElementById("closeGames");
      const btnTotal = document.getElementById("totaal");
      const selectedDice = document.getElementById("selectedDice");
      const gameWindow = document.getElementById("gameWindow");

      //wiring events

      btnCreate.addEventListener("click", (e) => {
        gameName = txtGameId.value;
        const payLoad = {
          method: "create",
          clientId: clientId,
          gameName: gameName,
        };

        ws.send(JSON.stringify(payLoad));
      });

      btnDice.addEventListener("click", (e) => {
        if (gameId === null) gameId = txtGameId.value;
        const payLoad = {
          method: "dice",
          clientId: clientId,
          gameId: gameId,
        };
        ws.send(JSON.stringify(payLoad));
      });

      endTurn.addEventListener("click", (e) => {
        if (gameId === null) gameId = txtGameId.value;
        const payLoad = {
          method: "endTurn",
          clientId: clientId,
          gameId: gameId,
        };
        ws.send(JSON.stringify(payLoad));
      });

      closeGames.addEventListener("click", (e) => {
        const payLoad = {
          method: "closeGames",
          clientId: clientId,
        };
        ws.send(JSON.stringify(payLoad));
      });

      ws.onmessage = (message) => {
        //message.data
        const response = JSON.parse(message.data);
        //connect
        if (response.method === "connect") {
          games = response.games;
          clientId = response.clientId;
          while (gamesList.firstChild) {
            gamesList.removeChild(gamesList.firstChild);
          }
          for (const property in games) {
            // console.log(`${property}: ${games[property].id}`);
            const g = document.createElement("div");
            gameId = games[property].id;
            g.classList.add("games-names");
            g.style.width = "200px";
            g.style.height = "50px";
            g.style.border = "thin solid green";
            g.textContent = games[property].gameName;
            g.value = gameId;
            const b = document.createElement("button");
            b.style.width = "60px";
            b.style.height = "60px";
            b.value = "test";
            b.textContent = "Join Game";
            b.addEventListener("click", (e) => {
              while (menuDiv.firstChild) {
                menuDiv.removeChild(menuDiv.firstChild);
              }
              gameWindow.style.visibility = "visible";
              const payLoad = {
                method: "join",
                clientId: clientId,
                gameId: gameId,
              };
              ws.send(JSON.stringify(payLoad));
            });
            g.appendChild(b);
            gamesList.appendChild(g);
          }

          console.log("Client id Set successfully " + clientId);
        }

        //create
        if (response.method === "create") {
          gameId = response.game.id;
          overgebleven = response.game.number;
          games = response.games;
          while (gamesList.firstChild) {
            gamesList.removeChild(gamesList.firstChild);
          }
          for (const property in games) {
            // console.log(`${property}: ${games[property].id}`);
            const g = document.createElement("div");
            const x = document.createElement("div");
            g.classList.add("games-names");
            g.style.width = "200px";
            g.style.height = "50px";
            g.style.border = "thin solid green";
            x.textContent = games[property].gameName;
            x.value = games[property].id;
            g.appendChild(x);
            const b = document.createElement("button");
            b.style.width = "60px";
            b.style.height = "60px";
            b.value = "test";
            b.textContent = "Join Game";
            b.addEventListener("click", (e) => {
              while (menuDiv.firstChild) {
                menuDiv.removeChild(menuDiv.firstChild);
              }
              gameWindow.style.visibility = "visible";
              const payLoad = {
                method: "join",
                clientId: clientId,
                gameId: gameId,
              };
              ws.send(JSON.stringify(payLoad));
            });
            g.appendChild(b);
            gamesList.appendChild(g);
          }
          console.log("game successfully created with id " + response.game.id);
        }
        if (response.method === "gamesClosed") {
          while (gamesList.firstChild) {
            gamesList.removeChild(gamesList.firstChild);
          }
        }
        //update
        if (response.method === "update") {
          if (!response.game.state) {
            return;
          }

          const currentPlayer = response.game.state["currentPlayer"];
          const diceThrown = response.game.state["diceThrown"];
          const resultaten = response.game.state["results"];
          const selectedResults = response.game.state["selectedResults"] || [];
          const overgeblevenTegels = response.game.state["tegels"];
          const player1Tegels = response.game.state["player1Tegels"];
          const player2Tegels = response.game.state["player2Tegels"];
          const total = response.game.state["total"];
          const player1Id = response.game.state["player1"];
          const player2Id = response.game.state["player2"];
          overgebleven = response.game.state["number"]; //dit moet beter

          determinePlayer(currentPlayer, diceThrown);
          createDices(resultaten, selectedResults);
          maaktegels(overgeblevenTegels);
          playerTegels(player1Tegels, player2Tegels);
          selectedTegels(selectedResults);

          btnTotal.textContent = total;
          const availableTegels = Array.from(divTegels.children, (x) =>
            parseInt(x.value)
          );
          const xGegooid = selectedResults.map((x) => x.dice).includes("X");

          if (total >= 21 && xGegooid) {
            if (availableTegels.includes(total)) {
              for (tegel of divTegels.children) {
                const tegelWaarde = parseInt(tegel.value);
                if (total === tegelWaarde) {
                  tegel.disabled = false;
                }
              }
            } else {
              eerstvolgende =
                Math.max.apply(
                  Math,
                  availableTegels.filter((x) => x < total)
                ) ?? 0;
              if (eerstvolgende > 1) {
                for (tegel of divTegels.children) {
                  if (parseInt(tegel.value) === eerstvolgende) {
                    tegel.disabled = false;
                  }
                }
              }
              if (
                total === parseInt(player1.firstChild.value) &&
                currentPlayer === player2Id
              ) {
                player1.firstChild.disabled = false;
              }
              if (
                total === parseInt(player2.firstChild.value) &&
                currentPlayer === player1Id
              ) {
                player2.firstChild.disabled = false;
              }
            }
          } else {
            for (tegel of divTegels.children) {
              tegel.disabled = true;
            }
          }
          if (currentPlayer !== clientId) {
            allButtons = document.querySelectorAll("button");
            allButtons.forEach((button) => (button.disabled = true));
          }
        }

        //join
        if (response.method === "join") {
          const game = response.game;
          const speeltegels = response.game.state.tegels;
          while (divPlayers.firstChild)
            divPlayers.removeChild(divPlayers.firstChild);

          game.clients.forEach((c) => {
            const d = document.createElement("div");
            d.style.width = "200px";
            d.style.background = c.color;
            d.textContent = c.clientId;
            divPlayers.appendChild(d);

            if (c.clientId === clientId) playerColor = c.color;
          });

          maaktegels(speeltegels);
        }
      };

      function maaktegels(tegels) {
        while (divTegels.firstChild) {
          divTegels.removeChild(divTegels.firstChild);
        }
        tegels.forEach((e) => {
          const b = document.createElement("button");
          b.style.width = "60px";
          b.style.height = "60px";
          b.value = e;
          b.textContent = e;
          b.disabled = true;
          divTegels.appendChild(b);
          b.addEventListener("click", (e) => {
            const payLoad = {
              method: "selectTegel",
              clientId: clientId,
              gameId: gameId,
              selectedTegel: b.value,
            };
            ws.send(JSON.stringify(payLoad));
          });
        });
      }

      function determinePlayer(currentPlayer, diceThrown) {
        for (let tegel of divBoard.children) {
          if (currentPlayer === clientId) {
            tegel.disabled = false;
          } else {
            tegel.disabled = true;
          }
        }
        if (currentPlayer === clientId) {
          btnDice.disabled = false;
          endTurn.disabled = true;
          if (diceThrown === "yes") {
            btnDice.disabled = true;
            endTurn.disabled = false;
          } else {
            btnDice.disabled = false;
          }
        } else {
          btnDice.disabled = true;
        }
      }

      function createDices(resultaten, selectedResults) {
        while (divBoard.firstChild) {
          divBoard.removeChild(divBoard.firstChild);
        }
        for (let i = 0; i < resultaten?.length; i++) {
          const b = document.createElement("button");
          obje = resultaten[i];
          b.id = "tegel" + (i + 1);
          b.tag = i + 1;
          waarde = obje["value"];
          text = obje["dice"];
          b.value = waarde;
          b.textContent = text;

          if (
            selectedResults.map((x) => String(x.dice))?.includes(String(text))
          ) {
            b.disabled = true;
          }
          b.style.width = "100px";
          b.style.height = "100px";
          b.addEventListener("click", (e) => {
            const payLoad = {
              method: "selectDice",
              clientId: clientId,
              gameId: gameId,
              selectedValue: { dice: b.textContent, value: b.value },
              results: resultaten,
              number: overgebleven,
              selectedResults: selectedResults,
              total: total,
            };
            ws.send(JSON.stringify(payLoad));
          });
          divBoard.appendChild(b);
        }
      }
      function playerTegels(player1Tegels, player2Tegels) {
        player1Tegels = player1Tegels.reverse();
        while (player1.firstChild) player1.removeChild(player1.firstChild);
        for (let i = 0; i < player1Tegels.length; i++) {
          const b = document.createElement("button");
          waarde = player1Tegels[i];
          b.textContent = waarde;
          b.value = waarde;
          b.disabled = true;
          player1.appendChild(b);
        }
        player2Tegels = player2Tegels.reverse();
        while (player2.firstChild) player2.removeChild(player2.firstChild);
        for (let i = 0; i < player2Tegels.length; i++) {
          const b = document.createElement("button");
          waarde = player2Tegels[i];
          b.textContent = waarde;
          b.value = waarde;
          b.disabled = true;
          player2.appendChild(b);
        }
      }

      function selectedTegels(selectedResults) {
        while (selectedDice.firstChild) {
          selectedDice.removeChild(selectedDice.firstChild);
        }
        for (let i = 0; i < selectedResults?.length; i++) {
          const b = document.createElement("button");
          obje = selectedResults[i];
          b.textContent = obje["dice"];
          b.value = obje["value"];

          b.style.width = "100px";
          b.style.height = "100px";
          selectedDice.appendChild(b);
        }
      }
    </script>
  </body>
</html>
