<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dobbelspelletje</title>
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body>
    <h1>dobbelspelletje</h1>
    <div id="menu">
      <button id="btnCreate">New Game</button>
      <button id="btnJoin">Join Game</button>
      <input type="text" id="txtGameId" />
      <div id="gamesList"></div>
      <button id="closeGames">Close Games</button>
    </div>
    <div id="gameWindow">
      <div id="player1board">
        player1
        <div id="player1"></div>
      </div>
      <div id="gameScreen">
        <button id="btnDice">Throw dice</button>
        <button id="endTurn">End turn</button>

        <div id="divPlayers"></div>
        <div id="tegels"></div>
        <hr />
        <div id="divBoard"></div>
        <div id="totaal"></div>
        <div id="selectedDice"></div>
      </div>
      <div id="player2board">
        player2
        <div id="player2"></div>
      </div>
    </div>
    <script>
      //HTML elements
      let clientId = null;
      let gameId = null;
      let playerColor = null;
      let overgebleven = null;
      let total = null;

      let HOST = location.origin.replace(/^http/, "ws");
      let ws = new WebSocket(HOST);
      const btnCreate = document.getElementById("btnCreate");
      const menuDiv = document.getElementById("menu");
      const btnJoin = document.getElementById("btnJoin");
      const txtGameId = document.getElementById("txtGameId");
      const divTegels = document.getElementById("tegels");
      const divPlayers = document.getElementById("divPlayers");
      const divBoard = document.getElementById("divBoard");
      const player1 = document.getElementById("player1");
      const gamesList = document.getElementById("gamesList");
      const btnDice = document.getElementById("btnDice");
      const endTurn = document.getElementById("endTurn");
      const closeGames = document.getElementById("closeGames");
      const btnTotal = document.getElementById("totaal");
      const selectedDice = document.getElementById("selectedDice");
      const gameWindow = document.getElementById("gameWindow");

      //wiring events
      btnJoin.addEventListener("click", (e) => {
        if (gameId === null) gameId = txtGameId.value;
        while (menuDiv.firstChild) menuDiv.removeChild(menuDiv.firstChild);
        gameWindow.style.visibility = "visible";
        const payLoad = {
          method: "join",
          clientId: clientId,
          gameId: gameId,
        };
        ws.send(JSON.stringify(payLoad));
      });

      btnCreate.addEventListener("click", (e) => {
        const payLoad = {
          method: "create",
          clientId: clientId,
        };

        ws.send(JSON.stringify(payLoad));
      });

      btnDice.addEventListener("click", (e) => {
        if (gameId === null) gameId = txtGameId.value;
        const payLoad = {
          method: "dice",
          clientId: clientId,
          gameId: gameId,
        };
        ws.send(JSON.stringify(payLoad));
      });

      endTurn.addEventListener("click", (e) => {
        if (gameId === null) gameId = txtGameId.value;
        const payLoad = {
          method: "endTurn",
          clientId: clientId,
          gameId: gameId,
        };
        ws.send(JSON.stringify(payLoad));
      });

      closeGames.addEventListener("click", (e) => {
        const payLoad = {
          method: "closeGames",
          clientId: clientId,
        };
        ws.send(JSON.stringify(payLoad));
      });

      ws.onmessage = (message) => {
        //message.data
        const response = JSON.parse(message.data);
        //connect
        if (response.method === "connect") {
          clientId = response.clientId;
          console.log("Client id Set successfully " + clientId);
        }

        //create
        if (response.method === "create") {
          gameId = response.game.id;
          overgebleven = response.game.number;
          games = Object.keys(response.games);
          for (let i = 0; i < games.length; i++) {
            const g = document.createElement("div");
            g.style.width = "200px";
            g.textContent = games[i];
            gamesList.appendChild(g);
          }
          console.log("game successfully created with id " + response.game.id);
        }

        //update
        if (response.method === "update") {
          if (!response.game.state) {
            return;
          }

          const currentPlayer = response.game.state["currentPlayer"];
          const diceThrown = response.game.state["diceThrown"];
          const resultaten = response.game.state["results"];
          const selectedResults = response.game.state["selectedResults"] || [];
          const overgeblevenTegels = response.game.state["tegels"];
          const player1Tegels = response.game.state["player1Tegels"];
          const player2Tegels = response.game.state["player2Tegels"];
          const total = response.game.state["total"];
          overgebleven = response.game.state["number"];

          determinePlayer(currentPlayer, diceThrown);
          createDices(resultaten, selectedResults);
          maaktegels(overgeblevenTegels);
          playerTegels(player1Tegels, player2Tegels);
          console.log("selectedResults", selectedResults);
          selectedTegels(selectedResults);

          btnTotal.textContent = total;
          if (total >= 21) {
            for (let i = 0; i < divTegels.children.length; i++) {
              if (
                total === parseInt(divTegels.children[i].value) &&
                selectedResults.map((x) => x.dice).includes("X")
              ) {
                divTegels.children[i].disabled = false;
              } else if (
                divTegels.length > 1 &&
                selectedResults.map((x) => x.dice).includes("X")
              ) {
                swag = divTegels.children.map(x => x.value)
                let result = Math.max.apply(Math, swag.filter( x => x < b));
                if(parseInt(divTegels.children[i] === result)){
                divTegels.children[i].disabled = false;
                }
              } else {
                divTegels.children[i].disabled = true;
              }
            }
            if(player1.firstChild || player2.firstChild){
            if (total === parseInt(player1.firstChild?.value)) {
              console.log(player1.firstChild)
              player1.firstChild.disabled = false;
            } else if (total === parseInt(player2.firstChild?.value)) {
               console.log(player2.firstChild)
              player2.firstChild.disabled = false;
            } else {
              player1.firstChild.disabled = true;
              player2.firstChild.disabled = true;
            }
          }}

          if (currentPlayer !== clientId) {
            bla = document.querySelectorAll("button");
            bla.forEach((x) => (x.disabled = true));
          }
        }

        //join
        if (response.method === "join") {
          const game = response.game;
          const speeltegels = response.game.state.tegels;
          while (divPlayers.firstChild)
            divPlayers.removeChild(divPlayers.firstChild);

          game.clients.forEach((c) => {
            const d = document.createElement("div");
            d.style.width = "200px";
            d.style.background = c.color;
            d.textContent = c.clientId;
            divPlayers.appendChild(d);

            if (c.clientId === clientId) playerColor = c.color;
          });

          maaktegels(speeltegels);
        }
      };

      function maaktegels(tegels) {
        while (divTegels.firstChild) {
          divTegels.removeChild(divTegels.firstChild);
        }
        tegels.forEach((e) => {
          const b = document.createElement("button");
          b.style.width = "60px";
          b.style.height = "60px";
          b.value = e;
          b.textContent = e;
          b.disabled = true;
          divTegels.appendChild(b);
          b.addEventListener("click", (e) => {
            const payLoad = {
              method: "selectTegel",
              clientId: clientId,
              gameId: gameId,
              selectedTegel: b.value,
            };
            ws.send(JSON.stringify(payLoad));
          });
        });
      }

      function determinePlayer(currentPlayer, diceThrown) {
        for (let tegel of divBoard.children) {
          if (currentPlayer === clientId) {
            tegel.disabled = false;
          } else {
            tegel.disabled = true;
          }
        }
        if (currentPlayer === clientId) {
          btnDice.disabled = false;
          if (diceThrown === "yes") {
            btnDice.disabled = true;
            endTurn.disabled = false;
          } else {
            btnDice.disabled = false;
          }
        } else {
          btnDice.disabled = true;
        }
      }

      function createDices(resultaten, selectedResults) {
        while (divBoard.firstChild) {
          divBoard.removeChild(divBoard.firstChild);
        }
        for (let i = 0; i < resultaten?.length; i++) {
          const b = document.createElement("button");
          obje = resultaten[i];
          b.id = "tegel" + (i + 1);
          b.tag = i + 1;
          waarde = obje["value"];
          text = obje["dice"];
          b.value = waarde;
          b.textContent = text;

          if (
            selectedResults.map((x) => String(x.dice))?.includes(String(text))
          ) {
            b.disabled = true;
          }
          b.style.width = "100px";
          b.style.height = "100px";
          b.addEventListener("click", (e) => {
            const payLoad = {
              method: "selectDice",
              clientId: clientId,
              gameId: gameId,
              selectedValue: { dice: b.textContent, value: b.value },
              results: resultaten,
              number: overgebleven,
              selectedResults: selectedResults,
              total: total,
            };
            console.log(payLoad);
            ws.send(JSON.stringify(payLoad));
          });
          divBoard.appendChild(b);
        }
      }
      function playerTegels(player1Tegels, player2Tegels) {
        player1Tegels = player1Tegels.reverse();
        while (player1.firstChild) player1.removeChild(player1.firstChild);
        for (let i = 0; i < player1Tegels.length; i++) {
          const b = document.createElement("button");
          waarde = player1Tegels[i];
          b.textContent = waarde;
          b.value = waarde;
          b.disabled = true;
          player1.appendChild(b);
        }
        player2Tegels = player2Tegels.reverse();
        while (player2.firstChild) player2.removeChild(player2.firstChild);
        for (let i = 0; i < player2Tegels.length; i++) {
          const b = document.createElement("button");
          waarde = player2Tegels[i];
          b.textContent = waarde;
          b.value = waarde;
          b.disabled = true;
          player2.appendChild(b);
        }
      }

      function selectedTegels(selectedResults) {
        while (selectedDice.firstChild) {
          selectedDice.removeChild(selectedDice.firstChild);
        }
        for (let i = 0; i < selectedResults?.length; i++) {
          const b = document.createElement("button");
          obje = selectedResults[i];
          b.textContent = obje["dice"];
          b.value = obje["value"];

          b.style.width = "100px";
          b.style.height = "100px";
          selectedDice.appendChild(b);
        }
      }
    </script>
  </body>
</html>
